<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <!-- Resource Hints for Performance -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://esm.sh">
    
    <!-- Preload Critical Resources -->
    <link rel="preload" href="css/common-styles.css" as="style">
    <link rel="preload" href="js/lazy-load.js" as="script">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepVape å®Œæ•´åŠŸèƒ½æ¸¬è©¦</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="css/main.css">
    <style>
        .test-section {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            border: 2px solid #dee2e6;
        }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
        }
        .test-pass {
            background: #d1e7dd;
            color: #0f5132;
        }
        .test-fail {
            background: #f8d7da;
            color: #842029;
        }
        .test-console {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .product-test-card {
            border: 2px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .image-test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .image-test-item {
            text-align: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .image-test-item img {
            max-width: 100%;
            height: 100px;
            object-fit: cover;
        }
    </style>

    <script src="js/meta-tags.js"></script>

    <style>
        /* Critical CSS */
        body { margin: 0; font-family: 'Noto Sans TC', sans-serif; }
        .lazy-loading { background: #f0f0f0; min-height: 100px; }
        .lazy-loaded { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div class="container my-5">
        <h1 class="text-center mb-5">ğŸ” DeepVape å®Œæ•´åŠŸèƒ½æ¸¬è©¦</h1>
        
        <!-- æ¸¬è©¦çµæœæ‘˜è¦ -->
        <div class="alert alert-info">
            <h4>æ¸¬è©¦ç‹€æ…‹</h4>
            <div>é€šé: <span id="passCount" class="badge bg-success">0</span></div>
            <div>å¤±æ•—: <span id="failCount" class="badge bg-danger">0</span></div>
            <div>ç¸½è¨ˆ: <span id="totalCount" class="badge bg-secondary">0</span></div>
        </div>

        <!-- 1. åœ–ç‰‡è¼‰å…¥æ¸¬è©¦ -->
        <div class="test-section">
            <h3>ğŸ“¸ 1. ç”¢å“åœ–ç‰‡è¼‰å…¥æ¸¬è©¦</h3>
            <div class="image-test-grid">
                <div class="image-test-item">
                    <img src="images/ui/deepvape_logo_main.png" alt="Logo" onload="markImagePass(this)" onerror="markImageFail(this)">
                    <p>Logo</p>
                </div>
                <div class="image-test-item">
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300'%3E%3Crect width='400' height='300' fill='%23f0f0f0'/%3E%3C/svg%3E" data-src="sp2_v/sp2_device_main_showcase.jpg" loading="lazy" alt="SP2 ä¸»æ©Ÿ" onload="markImagePass(this)" onerror="markImageFail(this)">
                    <p>SP2 ä¸»æ©Ÿ</p>
                </div>
                <div class="image-test-item">
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300'%3E%3Crect width='400' height='300' fill='%23f0f0f0'/%3E%3C/svg%3E" data-src="lana_a8000/lana_a8000.webp" loading="lazy" alt="LANA A8000" onload="markImagePass(this)" onerror="markImageFail(this)">
                    <p>LANA A8000</p>
                </div>
                <div class="image-test-item">
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300'%3E%3Crect width='400' height='300' fill='%23f0f0f0'/%3E%3C/svg%3E" data-src="ilia_1/ilia_gen1_main_device.jpg" loading="lazy" alt="ILIA ä¸€ä»£" onload="markImagePass(this)" onerror="markImageFail(this)">
                    <p>ILIA ä¸€ä»£</p>
                </div>
                <div class="image-test-item">
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300'%3E%3Crect width='400' height='300' fill='%23f0f0f0'/%3E%3C/svg%3E" data-src="hta_vape/hta_spade_device.webp" loading="lazy" alt="HTA é»‘æ¡ƒ" onload="markImagePass(this)" onerror="markImageFail(this)">
                    <p>HTA é»‘æ¡ƒ</p>
                </div>
                <div class="image-test-item">
                    <img src="images/ui/7-11_tklogo.jpg" alt="7-11 Logo" onload="markImagePass(this)" onerror="markImageFail(this)">
                    <p>7-11 Logo</p>
                </div>
            </div>
            <div id="imageTestResult" class="mt-3"></div>
        </div>

        <!-- 2. è³¼ç‰©è»ŠåŠŸèƒ½æ¸¬è©¦ -->
        <div class="test-section">
            <h3>ğŸ›’ 2. è³¼ç‰©è»Šæ“ä½œæ¸¬è©¦</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="product-test-card">
                        <h5>æ¸¬è©¦ç”¢å“ A</h5>
                        <p>åƒ¹æ ¼: NT$ 999</p>
                        <button class="btn btn-primary add-to-cart" 
                                data-product-id="test001"
                                data-product-name="æ¸¬è©¦ç”¢å“ A"
                                data-product-price="999"
                                data-product-image="images/ui/deepvape_logo_main.png"
                                data-product-flavor="è–„è·"
                                onclick="testAddToCart(this)">
                            åŠ å…¥è³¼ç‰©è»Š
                        </button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="product-test-card">
                        <h5>æ¸¬è©¦ç”¢å“ B</h5>
                        <p>åƒ¹æ ¼: NT$ 1299</p>
                        <button class="btn btn-primary add-to-cart" 
                                data-product-id="test002"
                                data-product-name="æ¸¬è©¦ç”¢å“ B"
                                data-product-price="1299"
                                data-product-image="images/ui/deepvape_logo_main.png"
                                data-product-color="é»‘è‰²"
                                onclick="testAddToCart(this)">
                            åŠ å…¥è³¼ç‰©è»Š
                        </button>
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <p>è³¼ç‰©è»Šæ•¸é‡: <span class="cart-count badge bg-danger">0</span></p>
                <button class="btn btn-info" onclick="testCartOperations()">æ¸¬è©¦è³¼ç‰©è»ŠåŠŸèƒ½</button>
                <button class="btn btn-warning" onclick="clearCart()">æ¸…ç©ºè³¼ç‰©è»Š</button>
            </div>
            <div id="cartTestResult" class="mt-3"></div>
        </div>

        <!-- 3. é–€å¸‚é¸æ“‡æ¸¬è©¦ -->
        <div class="test-section">
            <h3>ğŸª 3. é–€å¸‚é¸æ“‡åŠŸèƒ½æ¸¬è©¦</h3>
            <button class="btn btn-primary" onclick="testStoreSelector()">æ¸¬è©¦é–€å¸‚é¸æ“‡å™¨</button>
            <div id="selectedStore" class="mt-3" style="display: none;">
                <h5>å·²é¸æ“‡é–€å¸‚ï¼š</h5>
                <p id="storeName"></p>
                <p id="storeAddress"></p>
                <p id="storeId"></p>
            </div>
            <div id="storeTestResult" class="mt-3"></div>
        </div>

        <!-- 4. é é¢é€£çµæ¸¬è©¦ -->
        <div class="test-section">
            <h3>ğŸ”— 4. é é¢é€£çµåŠŸèƒ½æ¸¬è©¦</h3>
            <div class="row">
                <div class="col-md-6">
                    <h5>ä¸»è¦é é¢</h5>
                    <ul class="list-unstyled">
                        <li><a href="index.html" target="_blank">âœ“ é¦–é </a></li>
                        <li><a href="cart.html" target="_blank">âœ“ è³¼ç‰©è»Š</a></li>
                        <li><a href="order_confirmation.html" target="_blank">âœ“ è¨‚å–®ç¢ºèª</a></li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h5>éœæ…‹é é¢</h5>
                    <ul class="list-unstyled">
                        <li><a href="pages/shopping_guide.html" target="_blank">âœ“ è³¼ç‰©æŒ‡å—</a></li>
                        <li><a href="pages/shipping_info.html" target="_blank">âœ“ é…é€è³‡è¨Š</a></li>
                        <li><a href="pages/return_policy.html" target="_blank">âœ“ é€€æ›è²¨æ”¿ç­–</a></li>
                        <li><a href="pages/faq.html" target="_blank">âœ“ å¸¸è¦‹å•é¡Œ</a></li>
                        <li><a href="pages/brand_story.html" target="_blank">âœ“ å“ç‰Œæ•…äº‹</a></li>
                    </ul>
                </div>
            </div>
            <button class="btn btn-info" onclick="testAllLinks()">è‡ªå‹•æ¸¬è©¦æ‰€æœ‰é€£çµ</button>
            <div id="linkTestResult" class="mt-3"></div>
        </div>

        <!-- 5. API æ¸¬è©¦ -->
        <div class="test-section">
            <h3>ğŸ“± 5. API èˆ‡ Telegram æ¸¬è©¦</h3>
            <button class="btn btn-primary" onclick="testHealthAPI()">æ¸¬è©¦å¥åº·æª¢æŸ¥ API</button>
            <button class="btn btn-warning" onclick="testTelegramAPI()">æ¸¬è©¦ Telegram APIï¼ˆåƒ…æ¸¬è©¦é€£ç·šï¼‰</button>
            <div id="apiTestResult" class="mt-3"></div>
        </div>

        <!-- æ¸¬è©¦æ§åˆ¶å° -->
        <div class="test-section">
            <h3>ğŸ’» æ¸¬è©¦æ§åˆ¶å°</h3>
            <div id="testConsole" class="test-console"></div>
        </div>
    </div>

    <!-- è¼‰å…¥è³¼ç‰©è»Šé‚è¼¯ -->
    <script src="js/cart-logic.js"></script>
    <script src="js/store-selector.js"></script>
    <script src="components/common-components.js"></script>
    
    <script>
        let passCount = 0;
        let failCount = 0;
        const testResults = [];

        function log(message, type = 'info') {
            const console = document.getElementById('testConsole');
            const time = new Date().toLocaleTimeString();
            const color = type === 'pass' ? '#0f0' : type === 'fail' ? '#f00' : '#fff';
            console.innerHTML += `<div style="color: ${color}">[${time}] ${message}</div>`;
            console.scrollTop = console.scrollHeight;
        }

        function updateCounts() {
            document.getElementById('passCount').textContent = passCount;
            document.getElementById('failCount').textContent = failCount;
            document.getElementById('totalCount').textContent = passCount + failCount;
        }

        function markImagePass(img) {
            img.style.border = '3px solid #28a745';
            passCount++;
            updateCounts();
            log(`âœ… åœ–ç‰‡è¼‰å…¥æˆåŠŸ: ${img.alt}`, 'pass');
        }

        function markImageFail(img) {
            img.style.border = '3px solid #dc3545';
            failCount++;
            updateCounts();
            log(`âŒ åœ–ç‰‡è¼‰å…¥å¤±æ•—: ${img.alt}`, 'fail');
        }

        function testAddToCart(button) {
            try {
                if (window.cartManager) {
                    const product = {
                        id: button.dataset.productId,
                        name: button.dataset.productName,
                        price: parseFloat(button.dataset.productPrice),
                        image: button.dataset.productImage,
                        flavor: button.dataset.productFlavor,
                        color: button.dataset.productColor
                    };
                    
                    const result = cartManager.addItem(product);
                    if (result) {
                        passCount++;
                        log(`âœ… æˆåŠŸåŠ å…¥è³¼ç‰©è»Š: ${product.name}`, 'pass');
                    } else {
                        failCount++;
                        log(`âŒ åŠ å…¥è³¼ç‰©è»Šå¤±æ•—: ${product.name}`, 'fail');
                    }
                } else {
                    failCount++;
                    log('âŒ CartManager æœªè¼‰å…¥', 'fail');
                }
            } catch (error) {
                failCount++;
                log(`âŒ è³¼ç‰©è»ŠéŒ¯èª¤: ${error.message}`, 'fail');
            }
            updateCounts();
        }

        function testCartOperations() {
            const results = [];
            
            // æ¸¬è©¦è³¼ç‰©è»ŠåŸºæœ¬åŠŸèƒ½
            if (window.cartManager) {
                // æ¸¬è©¦å–å¾—è³¼ç‰©è»Š
                const cart = cartManager.getCart();
                results.push(`è³¼ç‰©è»Šå•†å“æ•¸: ${cart.length}`);
                
                // æ¸¬è©¦è¨ˆç®—ç¸½é¡
                const totals = cartManager.calculateTotals();
                results.push(`ç¸½é‡‘é¡: NT$ ${totals.total}`);
                
                // æ¸¬è©¦æ•¸é‡
                const count = cartManager.getItemCount();
                results.push(`ç¸½æ•¸é‡: ${count}`);
                
                passCount++;
                log('âœ… è³¼ç‰©è»Šæ“ä½œæ¸¬è©¦é€šé', 'pass');
            } else {
                failCount++;
                log('âŒ CartManager æœªåˆå§‹åŒ–', 'fail');
            }
            
            document.getElementById('cartTestResult').innerHTML = 
                `<div class="test-result test-pass">${results.join('<br>')}</div>`;
            updateCounts();
        }

        function clearCart() {
            if (window.cartManager) {
                cartManager.clearCart();
                log('âœ… è³¼ç‰©è»Šå·²æ¸…ç©º', 'pass');
            }
        }

        function testStoreSelector() {
            if (window.StoreSelector) {
                try {
                    const selector = new StoreSelector();
                    passCount++;
                    log('âœ… StoreSelector åˆå§‹åŒ–æˆåŠŸ', 'pass');
                    
                    // æ¨¡æ“¬é¸æ“‡é–€å¸‚
                    selector.setStore({
                        storeId: 'TEST001',
                        storeName: 'æ¸¬è©¦é–€å¸‚',
                        storeAddress: 'å°åŒ—å¸‚ä¿¡ç¾©å€æ¸¬è©¦è·¯1è™Ÿ'
                    });
                    
                    document.getElementById('selectedStore').style.display = 'block';
                    passCount++;
                    log('âœ… é–€å¸‚é¸æ“‡åŠŸèƒ½æ­£å¸¸', 'pass');
                } catch (error) {
                    failCount++;
                    log(`âŒ StoreSelector éŒ¯èª¤: ${error.message}`, 'fail');
                }
            } else {
                failCount++;
                log('âŒ StoreSelector æœªè¼‰å…¥', 'fail');
            }
            updateCounts();
        }

        async function testAllLinks() {
            const links = [
                'index.html',
                'cart.html',
                'pages/shopping_guide.html',
                'pages/shipping_info.html',
                'pages/return_policy.html',
                'pages/faq.html',
                'pages/brand_story.html'
            ];
            
            for (const link of links) {
                try {
                    const response = await fetch(link, { method: 'HEAD' });
                    if (response.ok) {
                        passCount++;
                        log(`âœ… é€£çµæ­£å¸¸: ${link}`, 'pass');
                    } else {
                        failCount++;
                        log(`âŒ é€£çµéŒ¯èª¤: ${link} (${response.status})`, 'fail');
                    }
                } catch (error) {
                    failCount++;
                    log(`âŒ ç„¡æ³•è¨ªå•: ${link}`, 'fail');
                }
            }
            updateCounts();
        }

        async function testHealthAPI() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                if (response.ok) {
                    passCount++;
                    log(`âœ… Health API æ­£å¸¸: ${JSON.stringify(data)}`, 'pass');
                } else {
                    failCount++;
                    log(`âŒ Health API éŒ¯èª¤: ${response.status}`, 'fail');
                }
            } catch (error) {
                failCount++;
                log(`âŒ ç„¡æ³•é€£æ¥åˆ° API ä¼ºæœå™¨ (è«‹ç¢ºä¿åŸ·è¡Œ npm start)`, 'fail');
            }
            updateCounts();
        }

        async function testTelegramAPI() {
            log('â„¹ï¸ Telegram API æ¸¬è©¦åƒ…æª¢æŸ¥ç«¯é»å­˜åœ¨æ€§ï¼Œä¸å¯¦éš›ç™¼é€è¨Šæ¯', 'info');
            
            try {
                const response = await fetch('/api/send-telegram', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ test: true })
                });
                
                if (response.status === 500 || response.status === 400) {
                    // API ç«¯é»å­˜åœ¨ä½†å¯èƒ½ç¼ºå°‘é…ç½®
                    passCount++;
                    log('âœ… Telegram API ç«¯é»å­˜åœ¨ï¼ˆéœ€è¦é…ç½®ç’°å¢ƒè®Šæ•¸ï¼‰', 'pass');
                } else if (response.ok) {
                    passCount++;
                    log('âœ… Telegram API ç«¯é»æ­£å¸¸', 'pass');
                } else {
                    failCount++;
                    log(`âŒ Telegram API éŒ¯èª¤: ${response.status}`, 'fail');
                }
            } catch (error) {
                log('âš ï¸ ç„¡æ³•æ¸¬è©¦ Telegram APIï¼ˆéœ€è¦ä¼ºæœå™¨é‹è¡Œï¼‰', 'info');
            }
            updateCounts();
        }

        // é é¢è¼‰å…¥æ™‚åŸ·è¡ŒåŸºæœ¬æ¸¬è©¦
        window.addEventListener('DOMContentLoaded', () => {
            log('ğŸš€ DeepVape åŠŸèƒ½æ¸¬è©¦é–‹å§‹', 'info');
            log(`âœ… CartManager: ${typeof cartManager !== 'undefined' ? 'å·²è¼‰å…¥' : 'æœªè¼‰å…¥'}`, 
                typeof cartManager !== 'undefined' ? 'pass' : 'fail');
            log(`âœ… StoreSelector: ${typeof StoreSelector !== 'undefined' ? 'å·²è¼‰å…¥' : 'æœªè¼‰å…¥'}`,
                typeof StoreSelector !== 'undefined' ? 'pass' : 'fail');
            log(`âœ… CommonComponents: ${typeof commonComponents !== 'undefined' ? 'å·²è¼‰å…¥' : 'æœªè¼‰å…¥'}`,
                typeof commonComponents !== 'undefined' ? 'pass' : 'fail');
                
            // è‡ªå‹•æ¸¬è©¦è³¼ç‰©è»Šæ•¸é‡æ›´æ–°
            if (window.cartManager) {
                cartManager.subscribe({
                    cartChanged: () => {
                        const count = cartManager.getItemCount();
                        document.querySelectorAll('.cart-count').forEach(el => {
                            el.textContent = count;
                        });
                    }
                });
            }
        });
    </script>
</body>
</html> 