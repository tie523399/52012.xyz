<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é–€å¸‚é¸æ“‡å›èª¿ | Image Vape</title>
    <link rel="icon" type="image/png" href="/nav_logo.png">
    <link rel="shortcut icon" type="image/png" href="/nav_logo.png">
    <link rel="apple-touch-icon" href="/nav_logo.png">
    <style>
        body {
            font-family: 'PingFang TC', 'PingFang SC', 'Helvetica Neue', 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #667eea 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            padding: 20px;
        }

        .callback-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 3rem;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
        }

        .loading-icon {
            font-size: 3rem;
            color: #1e3c72;
            margin-bottom: 1rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 1rem;
        }

        .message {
            color: #666;
            margin-bottom: 2rem;
        }

        .store-info {
            background: #f8f9fa;
            border-radius: 30px;
            padding: 1.5rem;
            margin: 1rem 0;
            text-align: left;
            display: none;
        }

        .store-info h4 {
            color: #1e3c72;
            margin-bottom: 1rem;
        }

        .store-info div {
            margin-bottom: 0.5rem;
            color: #ffffff;
        }

        .btn {
            background: linear-gradient(135deg, #1e3c72, #667eea);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(30, 60, 114, 0.3);
        }

        .error {
            color: #e74c3c;
            background: #ffeaea;
            padding: 1rem;
            border-radius: 30px;
            margin: 1rem 0;
            display: none;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="callback-container">
        <div class="loading-icon">
            <i class="fas fa-spinner"></i>
        </div>
        <h2 class="title">è™•ç†é–€å¸‚é¸æ“‡</h2>
        <p class="message">æ­£åœ¨è™•ç†æ‚¨é¸æ“‡çš„é–€å¸‚è³‡è¨Š...</p>
        
        <div id="storeInfo" class="store-info">
            <h4><i class="fas fa-store"></i> å·²é¸æ“‡é–€å¸‚</h4>
            <div id="storeDetails"></div>
        </div>
        
        <div id="errorMessage" class="error"></div>
        
        <button id="confirmBtn" class="btn" onclick="confirmSelection()" style="display: none;">
            <i class="fas fa-check"></i> ç¢ºèªé¸æ“‡
        </button>
        
        <button class="btn" onclick="testStoreSelection()" style="background: #ffc107;">
            <i class="fas fa-flask"></i> æ¸¬è©¦é–€å¸‚é¸æ“‡
        </button>
        
        <button class="btn" onclick="window.close()">
            <i class="fas fa-times"></i> é—œé–‰è¦–çª—
        </button>
    </div>

    <script>
        let selectedStoreData = null;

        /*
         * é‡è¦èªªæ˜ï¼š7-11 API æ•´åˆçš„æŒ‘æˆ°
         * 
         * 1. 7-11 æœƒä½¿ç”¨ POST æ–¹æ³•å°‡é–€å¸‚è³‡æ–™ç™¼é€åˆ°é€™å€‹é é¢
         * 2. ç´”å‰ç«¯ JavaScript ç„¡æ³•ç›´æ¥è®€å– POST body
         * 3. è§£æ±ºæ–¹æ¡ˆï¼š
         *    a) ä½¿ç”¨ Netlify Functions ä½œç‚ºä¸­ä»‹ï¼ˆæ¨è–¦ï¼‰
         *    b) å‡è¨­ 7-11 ä¹Ÿæœƒå°‡è³‡æ–™ä½œç‚º GET åƒæ•¸é™„åŠ 
         *    c) æª¢æŸ¥è¡¨å–®è‡ªå‹•æäº¤æ¨¡å¼
         * 
         * åƒè€ƒï¼šdocs/7-11-integration.md
         */

        // åœ¨é é¢è¼‰å…¥å‰å°±å˜—è©¦ç²å–è³‡æ–™
        (function() {
            console.log('ğŸ” é–‹å§‹æª¢æŸ¥ 7-11 å›èª¿è³‡æ–™...');
            console.log('ç•¶å‰ URL:', window.location.href);
            console.log('ä¾†æºç¶²å€:', document.referrer);
            
            // æª¢æŸ¥æ˜¯å¦å¾ 7-11 å®˜æ–¹ç¶²ç«™ä¾†çš„è«‹æ±‚
            const is711Referrer = document.referrer && 
                (document.referrer.includes('emap.pcsc.com.tw') || 
                 document.referrer.includes('emap.presco.com.tw') ||
                 document.referrer.includes('eservice.7-11.com.tw'));
            
            if (is711Referrer) {
                console.log('âœ… ç¢ºèªä¾†è‡ª 7-11 å®˜æ–¹ç¶²ç«™');
                
                // æ–¹æ¡ˆ 1: æª¢æŸ¥ URL åƒæ•¸ (GET æ–¹å¼)
                if (window.location.search) {
                    console.log('ğŸ“Œ ç™¼ç¾ URL åƒæ•¸:', window.location.search);
                    // ç¨å¾Œåœ¨ DOMContentLoaded ä¸­è™•ç†
                }
                
                // æ–¹æ¡ˆ 2: æª¢æŸ¥ hash åƒæ•¸
                if (window.location.hash) {
                    console.log('ğŸ“Œ ç™¼ç¾ Hash åƒæ•¸:', window.location.hash);
                }
                
                // æ–¹æ¡ˆ 3: ç­‰å¾…å¯èƒ½çš„è¡¨å–®è‡ªå‹•æäº¤
                console.log('â³ ç­‰å¾…å¯èƒ½çš„ POST è³‡æ–™è¼‰å…¥...');
                
                /*
                 * æ³¨æ„ï¼šå¦‚æœ 7-11 ä½¿ç”¨ç´” POST æ–¹å¼ï¼Œ
                 * æˆ‘å€‘éœ€è¦åœ¨ä¼ºæœå™¨ç«¯è™•ç†ï¼ˆå¦‚ Netlify Functionsï¼‰
                 * ç„¶å¾Œé‡å®šå‘åˆ°é€™å€‹é é¢ä¸¦é™„åŠ  GET åƒæ•¸
                 */
                
                // ç›£è½è¡¨å–®è¼‰å…¥
                window.addEventListener('load', function() {
                    // æª¢æŸ¥æ˜¯å¦æœ‰è¡¨å–®è¢«æäº¤
                    const forms = document.getElementsByTagName('form');
                    console.log('æ‰¾åˆ°è¡¨å–®æ•¸é‡:', forms.length);
                    
                    // å¦‚æœé é¢ä¸­æœ‰éš±è—çš„inputæ¬„ä½ï¼ˆ7-11 APIå¯èƒ½æœƒé€™æ¨£å‚³è³‡æ–™ï¼‰
                    const inputs = document.getElementsByTagName('input');
                    const postData = {};
                    for (let input of inputs) {
                        if (input.name && input.value) {
                            postData[input.name] = input.value;
                            console.log('æ‰¾åˆ° input æ¬„ä½:', input.name, '=', input.value);
                        }
                    }
                    
                    // å¦‚æœæœ‰æ‰¾åˆ°è³‡æ–™ï¼Œè™•ç†å®ƒ
                    if (postData.CVSStoreID || postData.storeId) {
                        processStoreSelection({
                            storeId: postData.CVSStoreID || postData.storeId,
                            storeName: postData.CVSStoreName || postData.storeName,
                            storeAddress: postData.CVSAddress || postData.storeAddress,
                            storePhone: postData.CVSTelephone || postData.storePhone
                        });
                    }
                });
            } else {
                console.log('âš ï¸ é 7-11 ä¾†æºï¼Œå¯èƒ½æ˜¯é–‹ç™¼æ¸¬è©¦');
            }
        })();

        document.addEventListener('DOMContentLoaded', function() {
            console.log('CVSå›èª¿é é¢è¼‰å…¥å®Œæˆ');
            console.log('ç•¶å‰URL:', window.location.href);
            console.log('Referrer:', document.referrer);
            
            // è§£æ URL åƒæ•¸
            const urlParams = new URLSearchParams(window.location.search);
            console.log('URLåƒæ•¸:', Object.fromEntries(urlParams));
            
            // æª¢æŸ¥ 7-11 API çš„æ¨™æº–åƒæ•¸
            const storeData = {
                storeId: urlParams.get('CVSStoreID') || urlParams.get('storeId') || urlParams.get('storeid') || urlParams.get('StoreID'),
                storeName: urlParams.get('CVSStoreName') || urlParams.get('storeName') || urlParams.get('storename') || urlParams.get('StoreName'),
                storeAddress: urlParams.get('CVSAddress') || urlParams.get('storeAddress') || urlParams.get('storeaddress') || urlParams.get('Address'),
                storePhone: urlParams.get('CVSTelephone') || urlParams.get('storePhone') || urlParams.get('storephone') || urlParams.get('Telephone')
            };
            
            console.log('è§£æçš„é–€å¸‚è³‡æ–™:', storeData);
            
            // æª¢æŸ¥æ˜¯å¦æœ‰ POST è³‡æ–™æˆ– hash è³‡æ–™
            if (window.location.hash) {
                try {
                    const hashData = decodeURIComponent(window.location.hash.substring(1));
                    console.log('Hashè³‡æ–™:', hashData);
                    const params = new URLSearchParams(hashData);
                    
                    if (params.get('CVSStoreID') || params.get('storeId')) {
                        const hashStoreData = {
                            storeId: params.get('CVSStoreID') || params.get('storeId'),
                            storeName: params.get('CVSStoreName') || params.get('storeName'),
                            storeAddress: params.get('CVSAddress') || params.get('storeAddress'),
                            storePhone: params.get('CVSTelephone') || params.get('storePhone')
                        };
                        console.log('Hashè§£æé–€å¸‚è³‡æ–™:', hashStoreData);
                        processStoreSelection(hashStoreData);
                        return;
                    }
                } catch (e) {
                    console.error('è§£æ hash åƒæ•¸å¤±æ•—:', e);
                }
            }
            
            // æª¢æŸ¥ URL åƒæ•¸
            if (storeData.storeId || storeData.storeName) {
                processStoreSelection(storeData);
            } else {
                // ç«‹å³æª¢æŸ¥ 7-11 API å›èª¿
                if (!handle711Callback()) {
                    setTimeout(() => {
                        if (!selectedStoreData) {
                            console.log('æœªæ”¶åˆ°é–€å¸‚è³‡æ–™');
                            showError('æœªæ¥æ”¶åˆ°é–€å¸‚é¸æ“‡è³‡è¨Šï¼Œè«‹é‡æ–°é¸æ“‡é–€å¸‚æˆ–æ‰‹å‹•è¼¸å…¥ã€‚');
                        }
                    }, 2000);
                }
            }
            
            // ç›£è½ä¾†è‡ªçˆ¶è¦–çª—çš„è¨Šæ¯
            window.addEventListener('message', function(event) {
                console.log('æ”¶åˆ°çˆ¶è¦–çª—è¨Šæ¯:', event.data);
                if (event.data && event.data.storeInfo) {
                    processStoreSelection(event.data.storeInfo);
                }
            });
            
            // æª¢æŸ¥æ˜¯å¦åœ¨ iframe ä¸­
            if (window.parent !== window) {
                console.log('åœ¨iframeä¸­é‹è¡Œ');
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰ opener
            if (window.opener) {
                console.log('æœ‰openerè¦–çª—');
            }
        });

        function processStoreSelection(storeData) {
            if (!storeData || (!storeData.storeId && !storeData.storeName)) {
                showError('é–€å¸‚è³‡è¨Šä¸å®Œæ•´ï¼Œè«‹é‡æ–°é¸æ“‡');
                return;
            }

            selectedStoreData = {
                storeId: storeData.storeId || 'N/A',
                storeName: storeData.storeName || 'æœªçŸ¥é–€å¸‚',
                storeAddress: storeData.storeAddress || 'åœ°å€æœªæä¾›',
                storePhone: storeData.storePhone || 'é›»è©±æœªæä¾›'
            };

            // éš±è—è¼‰å…¥å‹•ç•«
            document.querySelector('.loading-icon').style.display = 'none';
            
            // æ›´æ–°æ¨™é¡Œå’Œè¨Šæ¯
            document.querySelector('.title').textContent = 'é–€å¸‚é¸æ“‡æˆåŠŸ';
            document.querySelector('.message').textContent = 'è«‹ç¢ºèªä»¥ä¸‹é–€å¸‚è³‡è¨Šæ˜¯å¦æ­£ç¢ºï¼š';
            
            // é¡¯ç¤ºé–€å¸‚è³‡è¨Š
            const storeInfoDiv = document.getElementById('storeInfo');
            const storeDetailsDiv = document.getElementById('storeDetails');
            
            storeDetailsDiv.innerHTML = `
                <div><strong>é–€å¸‚ç·¨è™Ÿï¼š</strong>${selectedStoreData.storeId}</div>
                <div><strong>é–€å¸‚åç¨±ï¼š</strong>${selectedStoreData.storeName}</div>
                <div><strong>é–€å¸‚åœ°å€ï¼š</strong>${selectedStoreData.storeAddress}</div>
                <div><strong>é–€å¸‚é›»è©±ï¼š</strong>${selectedStoreData.storePhone}</div>
            `;
            
            storeInfoDiv.style.display = 'block';
            document.getElementById('confirmBtn').style.display = 'inline-block';
        }

        function confirmSelection() {
            if (!selectedStoreData) {
                showError('æ²’æœ‰é¸æ“‡çš„é–€å¸‚è³‡è¨Š');
                return;
            }

            console.log('ç¢ºèªé¸æ“‡é–€å¸‚:', selectedStoreData);

            try {
                const messageData = {
                    type: 'storeSelected',
                    storeInfo: selectedStoreData
                };
                
                console.log('æº–å‚™ç™¼é€è¨Šæ¯:', messageData);
                
                // å–å¾—ä¾†æºç¶²åŸŸï¼ˆç‚ºäº†å®‰å…¨æ€§ï¼‰
                const targetOrigin = window.location.origin;
                console.log('ç›®æ¨™ä¾†æº:', targetOrigin);
                
                // å‘çˆ¶è¦–çª—ç™¼é€é–€å¸‚è³‡è¨Š
                if (window.opener && !window.opener.closed) {
                    console.log('å‘openerç™¼é€è¨Šæ¯');
                    window.opener.postMessage(messageData, targetOrigin);
                }
                
                // ä¹Ÿå˜—è©¦å‘çˆ¶æ¡†æ¶ç™¼é€
                if (window.parent && window.parent !== window) {
                    console.log('å‘parentç™¼é€è¨Šæ¯');
                    window.parent.postMessage(messageData, targetOrigin);
                }
                
                // å˜—è©¦å‘æ‰€æœ‰å¯èƒ½çš„ç›®æ¨™ç™¼é€
                try {
                    window.top.postMessage(messageData, targetOrigin);
                } catch (e) {
                    console.log('ç„¡æ³•å‘topç™¼é€è¨Šæ¯:', e);
                }
                
                // æ›´æ–°é¡¯ç¤º
                document.querySelector('.title').textContent = 'é–€å¸‚é¸æ“‡å®Œæˆ';
                document.querySelector('.message').textContent = 'é–€å¸‚è³‡è¨Šå·²å‚³é€ï¼Œè¦–çª—å°‡è‡ªå‹•é—œé–‰...';
                document.getElementById('confirmBtn').style.display = 'none';
                
                // å»¶é•·ç­‰å¾…æ™‚é–“ï¼Œç¢ºä¿è¨Šæ¯å‚³é€æˆåŠŸ
                setTimeout(() => {
                    console.log('æº–å‚™é—œé–‰è¦–çª—');
                    window.close();
                }, 2000);
                
            } catch (error) {
                console.error('å‚³é€é–€å¸‚è³‡è¨Šå¤±æ•—:', error);
                showError('å‚³é€é–€å¸‚è³‡è¨Šå¤±æ•—ï¼Œè«‹æ‰‹å‹•é—œé–‰è¦–çª—ä¸¦é‡æ–°é¸æ“‡');
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            // éš±è—è¼‰å…¥å‹•ç•«
            document.querySelector('.loading-icon').style.display = 'none';
            
            // æ›´æ–°æ¨™é¡Œ
            document.querySelector('.title').textContent = 'é¸æ“‡å¤±æ•—';
            document.querySelector('.message').textContent = 'è«‹é‡æ–°é¸æ“‡é–€å¸‚æˆ–è¯çµ¡å®¢æœ';
        }

        // è™•ç† 7-11 API çš„ç‰¹æ®Šå›èª¿æ ¼å¼
        function handle711Callback() {
            // 7-11 API å¯èƒ½æœƒåœ¨ URL ä¸­åŒ…å«ç‰¹æ®Šåƒæ•¸
            const url = window.location.href;
            console.log('æª¢æŸ¥7-11 APIå›èª¿åƒæ•¸...');
            
            // å„ªå…ˆæª¢æŸ¥æ¨™æº–çš„ 7-11 API åƒæ•¸
            const params = new URLSearchParams(window.location.search);
            
            // 7-11 API æ¨™æº–åƒæ•¸åç¨±
            const storeId = params.get('CVSStoreID') || params.get('storeId') || params.get('StoreID');
            const storeName = params.get('CVSStoreName') || params.get('storeName') || params.get('StoreName');
            const storeAddress = params.get('CVSAddress') || params.get('storeAddress') || params.get('Address');
            const storePhone = params.get('CVSTelephone') || params.get('storePhone') || params.get('Telephone');
            
            if (storeId || storeName) {
                console.log('æ‰¾åˆ°7-11é–€å¸‚è³‡æ–™:', { storeId, storeName, storeAddress, storePhone });
                
                processStoreSelection({
                    storeId: storeId,
                    storeName: storeName,
                    storeAddress: storeAddress,
                    storePhone: storePhone
                });
                return true;
            }
            
            // å¦‚æœæ²’æœ‰åœ¨URLåƒæ•¸ä¸­æ‰¾åˆ°ï¼Œå˜—è©¦å…¶ä»–æ–¹å¼
            // POSTè³‡æ–™å¯èƒ½éœ€è¦å¾å…¶ä»–åœ°æ–¹ç²å–
            if (document.referrer && document.referrer.includes('presco.com.tw')) {
                console.log('ä¾†è‡ª7-11å®˜æ–¹APIï¼Œä½†æœªåœ¨URLä¸­æ‰¾åˆ°åƒæ•¸');
                console.log('å¯èƒ½æ˜¯POSTè«‹æ±‚ï¼Œç­‰å¾…è³‡æ–™è¼‰å…¥...');
                
                // å»¶é²å†æ¬¡æª¢æŸ¥ï¼Œçµ¦POSTè³‡æ–™è¼‰å…¥çš„æ™‚é–“
                setTimeout(() => {
                    // å†æ¬¡å˜—è©¦ç²å–è³‡æ–™
                    const postStoreId = document.getElementById('CVSStoreID')?.value || 
                                       document.querySelector('[name="CVSStoreID"]')?.value;
                    const postStoreName = document.getElementById('CVSStoreName')?.value || 
                                         document.querySelector('[name="CVSStoreName"]')?.value;
                    const postStoreAddress = document.getElementById('CVSAddress')?.value || 
                                            document.querySelector('[name="CVSAddress"]')?.value;
                    const postStorePhone = document.getElementById('CVSTelephone')?.value || 
                                          document.querySelector('[name="CVSTelephone"]')?.value;
                    
                    if (postStoreId || postStoreName) {
                        console.log('å¾POSTè³‡æ–™ä¸­æ‰¾åˆ°é–€å¸‚è³‡è¨Š');
                        processStoreSelection({
                            storeId: postStoreId,
                            storeName: postStoreName,
                            storeAddress: postStoreAddress,
                            storePhone: postStorePhone
                        });
                    }
                }, 1000);
            }
            
            return false;
        }

        // æ¸¬è©¦é–€å¸‚é¸æ“‡åŠŸèƒ½
        function testStoreSelection() {
            console.log('åŸ·è¡Œæ¸¬è©¦é–€å¸‚é¸æ“‡');
            processStoreSelection({
                storeId: 'TEST001',
                storeName: 'çµ±ä¸€è¶…å•†æ¸¬è©¦é–€å¸‚',
                storeAddress: 'å°åŒ—å¸‚ä¿¡ç¾©å€ä¿¡ç¾©è·¯äº”æ®µ7è™Ÿ1æ¨“',
                storePhone: '02-2345-6789'
            });
        }

        window.onerror = function(msg, url, line) {
            console.error('å…¨åŸŸéŒ¯èª¤:', msg, 'æ–¼', url, 'ç¬¬', line, 'è¡Œ');
            showError('ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢æˆ–è¯çµ¡å®¢æœ');
            return false;
        };
    </script>
</body>
</html> 
